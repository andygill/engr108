<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="ico/favicon.png">

    <title>ENGR 108</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-theme.css" rel="stylesheet">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <link href="css/customize.css" rel="stylesheet">

  </head>

  <body>
  

<div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><b>Escape from Crater Lake</b></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class=""><a id="pause-button">Pause</a></li>
            <li class=""><a id="restart-button">Restart</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a id="login-button">Login</a></li>
            <li class=""><a id="edit-button">Edit Game</a></li>
            <li class="active"><a id="home-button">Introduction</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div id="debugging"></div>

      <div class="container">
        <div class="col-md-8">

          <div id="game-box">
              <canvas id="canvas" style="border: 1px solid red">
              </canvas>
          </div>
        </div>
        <div class="col-md-4">

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Escape from Crater Lake</h3>
            </div>
            <div class="panel-body">

                <p>Welcome to Escape from Crater Lake!</p>
                <ul>
                  <li>Your objective is to row off the lake, <u>without</u> Bigfoot catching you.</li>
                  <li>You can control your direction.</li>
                  <li>If you land on a green segment,you win.</li>
                  <li>If you land on a red segment, you lose.</li>
                  <li>You have one minute. </li>
                </ul>
                <p>Good luck!</p>

                <hr>

                <p>If you want to edit the game, then please log in</a>
                <form class="" method="POST">
                  <div class="form-group">
                    <input type="text" placeholder="Email" name="email" class="form-control">
                  </div>
                  <button type="submit" class="btn btn-primary">Sign in</button>
                </form>


            </div>
          </div>

      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/backbone.js"></script>
    <script>
    $(function() {
      var width = $("#game-box").width();
      $("#canvas").get(0).width = width;
      $("#canvas").get(0).height = width;

      $(window).resize(function () {
        // Hacky for now
//        $("#canvas").get(0).width = ?
//        $("#canvas").get(0).height = $("#game-box").width());
      });

      var DOCKS = 20;
      var LAKE_SIZE = 0.75;

      // Hack
      old_bf_x = 0;
      old_bf_y = 0;

      var dockNo = function (dir)  {
        
        if (dir < 0) {
          alert("hu!");
        } else {
          dir = (dir / (Math.PI * 2)) % 1;                    
        }
        // dock zero is at top.
        var n = Math.floor((1 - dir) * DOCKS);
        return (n % DOCKS);
      };


      //--------------------------------------------------------
      var Game = Backbone.Model.extend({  
            initialize: function(){  
            },  
              defaults: {  
                // Location of cursor
                go      : true,         // If game is active
                mouse   : null,         // cursor
                center  : { x : 0, y : 0 },
                pos     : { x : 0, y : 0 },
                wake    : [],
                dir     : 0,            // direction in radians
                bigfoot : 0, // Math.PI / 2,  // location of bigfoot
                size    : width,        // how big the canvas
                step    : 0,            // just a (stepper) counter
            }  
        });  

      var gameModel = new Game({});


      // Next, the nav bar
      //--------------------------------------------------------      
      var NavModel = Backbone.Model.extend({  
            initialize: function(){  
            },  
              defaults: {  
                // Which (radio) button is pressed
                active : 'home'
            }  
        });  
      

      var navModel = new NavModel();

      //--------------------------------------------------------
      
      var x;
      var y;
      
      var timeoutID; // Should this be in a model?


      var step = function () {
        var step = gameModel.get('step');
        step++;
        var pos = gameModel.get('pos');  // be careful, this is the original, not a copy
        var dir = gameModel.get('dir');
        var mouse = gameModel.get('mouse');
        var wake  = gameModel.get('wake');

        if (mouse != null) {
          var controlX = mouse.x - pos.x;
          var controlY = mouse.y - pos.y;
//          console.log({controlX: controlX, controlY : controlY });
          dir = Math.atan2(controlY,controlX);
//          console.log("dir: " + dir);
        }


        // Add the wake
        if (step % 5 == 0) {
          wake.push( { x: pos.x, y: pos.y, dir: dir } );
        }
        if (wake.length > 40) {
          wake.shift(); // throw away the furthest one
        }

        var bigfoot = gameModel.get('bigfoot');
        var bigfoot_speed = 4;

        bigfoot += bigfoot_speed / (width * LAKE_SIZE / 2);


//        console.log(dockNo(bigfoot));


        // Now, we need to compute a vector
        var xd = Math.cos(dir);
        var yd = Math.sin(dir);

        // And the updates
//        console.log("speed: " + Math.sqrt(xd * xd + yd * yd));
        pos.x += xd;
        pos.y += yd;

        gameModel.set( { step: step, pos: pos, dir : dir, bigfoot: bigfoot, wake: wake });
      };
      
      // pleaseStep says, at some point *soon* I will step the world.
      var pleaseStep = function() { 
        if (timeoutID == null) { // otherwise, one is scheduled anyway
          timeoutID = setTimeout(function () {
            timeoutID = null;
            step();
          },40);
        };
      };

      $("#debugging").html("start");
      var GameView = Backbone.View.extend({  
        el: $('#game-box'),
        tagName : "div",  
        id: "game",
        events : {
          "mousemove"  : "mousemove"
        },
        initialize : function() {  
          // code for rendering the HTML for the view  
          gameModel.on('change', this.render);
          this.render();
        },
        render: function() {
//          this.$el.html(gameModel.get("x"));
          var canvas = $("#canvas").get(0);
          var context = canvas.getContext('2d');  



          context.save();

          context.clearRect(0, 0, canvas.width, canvas.height);
          context.beginPath();

          var centerX = Math.floor(canvas.width / 2);
          var centerY = Math.floor(canvas.height / 2);
          var scale = Math.min (centerX,centerY);
          var radius = Math.floor(scale * LAKE_SIZE);
          var step = gameModel.get('step');
          var bigfoot = gameModel.get('bigfoot');
                    
          context.translate(centerX, centerY);

          context.beginPath();
          context.arc(0, 0, Math.floor(radius), 0, 2 * Math.PI, false);
          context.fillStyle = '#0099ff';
          context.fill();
          context.lineWidth = 1;
          context.strokeStyle = 'black';
          context.stroke();

          for (var i = 0;i < DOCKS; i++) {
            var start = i * 2 * Math.PI / DOCKS + 0.01;
            var end   = (i + 1) * 2 * Math.PI / DOCKS - 0.01;
            context.save();
            context.rotate(i * 2 * Math.PI / DOCKS);
            context.beginPath();
            context.arc(0, 0, Math.floor(radius), 1 * 2 * Math.PI / DOCKS - 0.01, 0.01, true);
            context.lineWidth = 10;
            if (dockNo(bigfoot) == i) {
              context.strokeStyle = '#ff0000';
            } else {
              context.strokeStyle = '#808080'; //            108020';              
            }
            context.stroke();
            context.restore();
          }

          // Print the bigfoot
          // Printing the boat
          context.save();
//          console.log(bigfoot);
          context.translate(Math.cos(bigfoot) * scale * 0.85,-Math.sin(bigfoot) * scale * 0.85);
          var bf_x = Math.cos(bigfoot) * scale * 0.75;
          var bf_y = -Math.sin(bigfoot) * scale * 0.75;
          var bf_x_s = old_bf_x - bf_x;
          var bf_y_s = old_bf_y - bf_y;
          console.log("speed: " + Math.sqrt(bf_x_s * bf_x_s + bf_y_s * bf_y_s));
          old_bf_x = bf_x;
          old_bf_y = bf_y;


          context.beginPath();
          context.rect(20, 10, -20, -10);
          context.fillStyle = 'yellow';
          context.fill();
          context.lineWidth = 2;
          context.strokeStyle = 'black';
          context.stroke();
          context.restore();

          // Now, the boat wake
          var wake = gameModel.get('wake');
          for(var i = 0;i < wake.length;i++) {
//            i = wake.length - 1;
            context.save();
            context.globalAlpha = 0.7 - 0.7 * (wake.length - i) / wake.length;
            context.translate(wake[i].x,wake[i].y);
            context.lineWidth = 1;
            context.strokeStyle = '#0000ff';
            context.beginPath();
            context.arc(0, 0, (wake.length - i) + ((step % 5) / 5), wake[i].dir + Math.PI/4, wake[i].dir + Math.PI/1.2, false);
            context.stroke();

            context.beginPath();
            context.arc(0, 0, (wake.length - i) + ((step % 5) / 5), wake[i].dir - Math.PI/4, wake[i].dir - Math.PI/1.2, true);
            context.stroke();
            context.restore();
          }


          // Printing the boat
          context.save();
          context.translate(gameModel.get('pos').x,gameModel.get('pos').y);
          context.rotate(gameModel.get('dir'));
          context.beginPath();
          context.rect(-10, -5, 20, 10);
          context.fillStyle = 'yellow';
          context.fill();
          context.lineWidth = 2;
          context.strokeStyle = 'black';
          context.stroke();
          context.restore();



          // Now print the mouse pointer (which is abs)

          var mouse = gameModel.get('mouse');
          if (mouse != null) {
            context.save();
            context.globalAlpha = 0.5;
            context.translate(mouse.x,mouse.y);
            context.beginPath();
            context.arc(0, 0, 30, 0, 2 * Math.PI, false);
            context.fillStyle = 'green';
            context.fill();
            context.restore();
         }

          // Final restore
          context.restore();


          // Next, request a redraw in the near future (it is an animation)
          if (gameModel.get('go')) {
            pleaseStep();
          }

        },
        mousemove : function (ev) {
          $("#debugging").html("move" );
            var targetOffset = $(ev.target).offset();
            // From https://gist.github.com/pedromg/2898946
            if(typeof ev.offsetX === "undefined" || typeof ev.offsetY === "undefined") {
              var targetOffset = $(ev.target).offset();
              ev.offsetX = ev.pageX - targetOffset.left;
              ev.offsetY = ev.pageY - targetOffset.top;
            }
            // Now normalize to center of screen
            var canvas = $("#canvas").get(0);

            gameModel.set({ mouse: { x: ev.offsetX - canvas.width/2- 1, y: ev.offsetY - canvas.height/2 - 2}});
//            console.log(gameModel.get('mouse'));
        },
        go : function () {
          
        },
        stop : function () {
          
        },
        

      });

      var gameView = new GameView({});

      var NavView = Backbone.View.extend({  
        el: $('.nav'),
        events: {
          "click #pause-button":    "pause",
          "click #restart-button":  "restart",
          "click #login-button":    "login",
          "click #edit-button":     "edit",
          "click #home-button":     "home"
        },
        initialize : function() {  
          // code for rendering the HTML for the view  
          navModel.on('change', this.render);
          this.render();
        },

        render: function() {
          $(".nav li").removeClass("active");
          $(".nav #" + navModel.get('active') + "-button").parent().addClass("active");
        },
/*
     <ul class="nav navbar-nav navbar-right">
            <li><a id="login-button">Login</a></li>
            <li class=""><a id="edit-button">Edit Game</a></li>
            <li class="active"><a id="home-button">Introduction</a></li>
          </ul>
  */
        pause :   function () { gameModel.set('go',false); },
        restart : function () { gameModel.set('go',true); },
        login :   function () { navModel.set('active','login'); },
        edit :   function () { navModel.set('active','edit'); },
        home :   function () { navModel.set('active','home'); }
      });

      var navView = new NavView({});

    });
    
    </script>
  </body>
</html>
